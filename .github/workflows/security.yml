name: Security Scanning

on:
  push:
    branches: [ main, master, develop, claude/** ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  secret-scanning:
    name: Secret & Credential Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Detect hardcoded secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-security:
    name: Dependency Vulnerability Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install safety
        run: pip install safety pip-audit

      - name: Check dependencies with Safety
        run: |
          echo "::group::Safety Check"
          # Check for known security vulnerabilities
          safety check --file requirements.txt --output text || true
          echo "::endgroup::"
        continue-on-error: true

      - name: Audit dependencies with pip-audit
        run: |
          echo "::group::Pip Audit"
          pip-audit -r requirements.txt || true
          echo "::endgroup::"
        continue-on-error: true

  code-security:
    name: Code Security Analysis (Bandit)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          echo "::group::Bandit Security Scan"
          # B404: import subprocess (common in trading bots)
          # B603: subprocess without shell=True (we use this safely)
          # B607: partial executable path (acceptable for known binaries)
          bandit -r . \
            -f json -o bandit-report.json \
            --exclude ./venv,./env,./.venv,./tests \
            --skip B404,B603,B607 || true

          # Also output to console
          bandit -r . \
            --exclude ./venv,./env,./.venv,./tests \
            --skip B404,B603,B607 \
            -f screen || true
          echo "::endgroup::"

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  credential-check:
    name: Verify Credential Management
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env files in repo
        run: |
          echo "::group::Check for committed .env files"
          if find . -name ".env" -not -path "./node_modules/*" -not -path "./venv/*" | grep -q .; then
            echo "âŒ ERROR: .env file found in repository!"
            echo "Please remove .env files and add them to .gitignore"
            exit 1
          else
            echo "âœ… No .env files found in repository"
          fi
          echo "::endgroup::"

      - name: Check for hardcoded API keys
        run: |
          echo "::group::Check for hardcoded credentials"
          # Check for common patterns of hardcoded credentials
          if grep -r -i "api_key\s*=\s*['\"][a-zA-Z0-9]\+" . \
            --exclude-dir={venv,env,.venv,.git,node_modules} \
            --exclude="*.md" \
            --exclude="*.example" \
            --exclude="credentials.py"; then
            echo "âš ï¸  WARNING: Potential hardcoded API keys found"
            echo "Please use environment variables instead"
            exit 0  # Warning only, don't fail
          else
            echo "âœ… No obvious hardcoded credentials found"
          fi
          echo "::endgroup::"

      - name: Verify .gitignore contains security files
        run: |
          echo "::group::Verify .gitignore"
          required_patterns=(
            ".env"
            "*.db"
            "access_token.txt"
            "*.log"
            "credentials.json"
          )

          missing_patterns=()
          for pattern in "${required_patterns[@]}"; do
            if ! grep -q "$pattern" .gitignore 2>/dev/null; then
              missing_patterns+=("$pattern")
            fi
          done

          if [ ${#missing_patterns[@]} -gt 0 ]; then
            echo "âš ï¸  WARNING: .gitignore is missing these patterns:"
            printf '%s\n' "${missing_patterns[@]}"
            exit 0  # Warning only
          else
            echo "âœ… .gitignore properly configured"
          fi
          echo "::endgroup::"

  sast:
    name: Static Application Security Testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/command-injection
            p/sql-injection

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-security, code-security, credential-check, sast]
    if: always()

    steps:
      - name: Security Summary
        run: |
          echo "### ðŸ”’ Security Scan Complete"
          echo ""
          echo "All security scans have been executed."
          echo "Please review any warnings or errors above."
          echo ""
          echo "**Security Checklist:**"
          echo "- âœ… Secret scanning"
          echo "- âœ… Dependency vulnerabilities"
          echo "- âœ… Code security (Bandit)"
          echo "- âœ… Credential management"
          echo "- âœ… Static analysis (Semgrep)"
          echo ""
          echo "Note: Some checks may show warnings but won't fail the build."
