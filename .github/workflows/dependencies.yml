name: Dependency Management

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Sundays at 10 AM UTC
    - cron: '0 10 * * 0'

jobs:
  dependency-install:
    name: Test Dependency Installation
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip setuptools wheel

      - name: Install dependencies
        run: |
          echo "::group::Installing dependencies from requirements.txt"
          pip install -r requirements.txt
          echo "::endgroup::"

      - name: Verify installations
        run: |
          echo "::group::Verify key packages"
          python -c "import kiteconnect; print(f'kiteconnect: {kiteconnect.__version__}')" || echo "kiteconnect not importable"
          python -c "import pandas; print(f'pandas: {pandas.__version__}')"
          python -c "import numpy; print(f'numpy: {numpy.__version__}')"
          python -c "from dotenv import load_dotenv; print('python-dotenv: OK')"
          echo "::endgroup::"

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pip-audit safety pipdeptree

      - name: Check for outdated packages
        run: |
          echo "::group::Outdated Packages"
          pip list --outdated || true
          echo "::endgroup::"

      - name: Show dependency tree
        run: |
          echo "::group::Dependency Tree"
          pipdeptree || true
          echo "::endgroup::"

      - name: Check for conflicting dependencies
        run: |
          echo "::group::Dependency Conflicts"
          pip check || true
          echo "::endgroup::"

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies and tools
        run: |
          pip install -r requirements.txt
          pip install pip-licenses

      - name: Check licenses
        run: |
          echo "::group::Package Licenses"
          pip-licenses --format=markdown --order=license
          echo "::endgroup::"

      - name: Check for non-permissive licenses
        run: |
          echo "::group::License Compliance"
          # Fail if GPL or AGPL licenses are found (optional - adjust as needed)
          if pip-licenses --format=csv | grep -i "GPL\|AGPL"; then
            echo "‚ö†Ô∏è  WARNING: GPL/AGPL licenses found"
            echo "Please review for license compatibility"
            # Don't fail, just warn
            exit 0
          else
            echo "‚úÖ No restrictive licenses found"
          fi
          echo "::endgroup::"

  requirements-validation:
    name: Validate Requirements Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check requirements.txt exists
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "‚ùå ERROR: requirements.txt not found"
            exit 1
          else
            echo "‚úÖ requirements.txt found"
          fi

      - name: Check for version pinning
        run: |
          echo "::group::Version Pinning Analysis"
          echo "Packages without version specifiers:"
          grep -v "==" requirements.txt | grep -v "^#" | grep -v "^$" || echo "All packages have version specifiers"
          echo "::endgroup::"

      - name: Validate requirements.txt syntax
        run: |
          echo "::group::Syntax Validation"
          python -m pip install --dry-run -r requirements.txt
          echo "‚úÖ requirements.txt is valid"
          echo "::endgroup::"

  python-compatibility:
    name: Python Version Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install vermin
        run: pip install vermin

      - name: Check minimum Python version
        run: |
          echo "::group::Python Version Compatibility"
          # Check what minimum Python version the code requires
          vermin --no-tips . || true
          echo "::endgroup::"

  summary:
    name: Dependency Check Summary
    runs-on: ubuntu-latest
    needs: [dependency-install, dependency-audit, license-check, requirements-validation]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "### üì¶ Dependency Management Complete"
          echo ""
          echo "**Checks performed:**"
          echo "- ‚úÖ Multi-platform installation testing"
          echo "- ‚úÖ Dependency audit and conflicts"
          echo "- ‚úÖ License compliance"
          echo "- ‚úÖ Requirements validation"
          echo ""
          echo "Review the logs above for any issues or warnings."
